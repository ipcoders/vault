---
# --------------------------------------------------------------------------
# Purpose:
#   This file contains tasks to query vault secrets and their content.
#
# Required Parameters:
#   - engine_name
#   - engine_type
#   - secret_name
#
# Set Variables:
#   - is_secret_empty: A secret could exist with or without content.
#     type: bool
#   - secret_content: Content of a given secret.
#     type: dict
#
# Usage Notes:
# --------------------------------------------------------------------------

- name: Role Prechecks - Required Vars
  when: >
        engine_name is not defined or 
        engine_type is not defined or
        secret_name is not defined
  block:
    - name: Error message
      ansible.builtin.debug:
        msg: "Required variables are missing, make sure engine_name, engine_type and secret_name variables are defined."

    - name: Stop execution
      meta: end_play

- name: Get secrets
  uri:
    url: "{{ vault_addr }}/v1/{{ engine_name }}/metadata/{{ secret_name }}"
    method: GET
    headers:
      X-Vault-Token: "{{ vault_token }}"
    status_code: [200, 201, 204, 404]
    return_content: true
    validate_certs: false
  register: result

- name: Show result
  when: result['status'] == 404
  ansible.builtin.debug:
    msg: "Secret does not exist"

- name: Secret exists
  when: result['status'] in [200, 201, 204]
  block:
    - name: Show result
      debug:
        msg: "Secret '{{ secret_name }}' exists }}"
   
    - name: Get content of secret
      uri:
        url: "{{ vault_addr }}/v1/{{ engine_name }}/data/{{ secret_name }}"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: [200, 201, 204, 404]
        return_content: true
        validate_certs: false
      ignore_errors: true
      register: secret_result

    - name: Secret has content
      when: secret_result['status'] in [200, 201, 204] 
      block:
        - name: Set var
          ansible.builtin.set_fact:
            is_secret_empty: false
            secret_content: "{{ secret_result['json']['data']['data'] }}"
          
        - name: Show result
          ansible.builtin.debug:
            msg: "Secret '{{ secret_name }}' exists and has contents }}"

    - name: Secret has no content
      when: secret_result['status'] == 404
      block:
        - name: Set var
          ansible.builtin.set_fact:
            is_secret_empty: true
            secret_content: ""

        - name: Show result
          ansible.builtin.debug:
            msg: "Secret '{{ secret_name }}' exists but is empty."

    - name: Unknown error
      when: secret_result['status'] not in [200, 201, 204, 404]
      block:
        - name: Show result
          ansible.builtin.debug:
            msg: "ERROR: Unknown error has occurred"

        - name: Stop execution
          meta: end_play

